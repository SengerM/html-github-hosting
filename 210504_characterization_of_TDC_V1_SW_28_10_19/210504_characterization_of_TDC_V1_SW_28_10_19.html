<!DOCTYPE html>
<html>

<head>
	<title>Characterization of the "fully digital TDC"</title>
	
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1"> <!-- This fixes the problem of small font (some texts and also the math) in mobile devices, see https://stackoverflow.com/a/35564095/8849755 -->
	<link rel="stylesheet" href="https://sengerm.github.io/html-academic-publishing/css_and_scripts/style.css">
	<link rel="stylesheet" href="https://sengerm.github.io/html-academic-publishing/css_and_scripts/presentation_display_block/presentation_display_block.css">
	<!-- Math support https://www.mathjax.org/#gettingstarted -->
	<script>
	MathJax = {
	  tex: {
		inlineMath: [['$', '$'], ['\\(', '\\)']]
	  },
	  svg: {
		fontCache: 'global'
	  }
	};
	</script>
	<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
	<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
	
</head>

<body>
	<siglas class="definition" first="TDC Version 1 designed by Stephan Wiederkehr and produced on October 20&lt;sup&gt;th&lt;&#47;sup&gt; 2029 (TDC V1 SW 28 10 19)" short="TDC V1 SW 28 10 19"></siglas>
	<siglas class="definition" first="Time to Digital Converter (TDC)" short="TDC"></siglas>
	
	<presentation_display_block>
		
		<div id="document_title"></div>
			
		<author affiliation="Universität Zürich">
			Matías Senger
		</author>
		
		<div style="width: 100%;text-align:center;margin: 10px;">
			<a href="https://en.wikipedia.org/wiki/Star_Wars_Day"><img src="media/360px-Star_Wars_Day_May_The_Fourth.png" alt="May the 4<sup>th</sup>" height="44px" style="vertical-align:middle;"></a>, 2021
		</div>
		
		<abstract>
		<p>In this document I present the characterization of the "fully digital TDC" to which, to be more specific, I refer to as the <siglas>TDC V1 SW 28 10 19</siglas>. First I briefly explain the block diagram of this circuit and then I proceed to the characterization process.</p>
		</abstract>
	</presentation_display_block>
	
	<presentation_display_block>
		<div id="table-of-contents">
			<h2 class="unnumbered">Table of contents</h2> <!-- Feel free to change this title. -->
			<!-- Here will be placed the table of contents -->
		</div>
	</presentation_display_block>
	
	<presentation_display_block>
		<h1>Introduction</h1>
		
		<p>In this section I will describe some details about the <siglas>TDC V1 SW 28 10 19</siglas> design as well as about the test setup employed for its characterization. The whole system can be divided into three hierarchical blocks:
		<ol>
			<li><b>The <siglas>TDC V1 SW 28 10 19</siglas>.</b> This is the <siglas>TDC</siglas> design we are interested in.</li>
			<li><b>The test structure.</b> This is the circuit implemented in the silicon which contains four identical <siglas>TDC V1 SW 28 10 19</siglas> replicas and peripheral circuitry for the operation.</li>
			<li><b>The test setup.</b> This is the whole measuring system composed of a Raspberry Pi, an FPGA, a specialized short-delay generation system and the test structure itself.</li>
		</ol>
		Each of these blocks contains the previous blocks, i.e. the <em>test setup</em> contains one <em>test structure</em> and the <em>test structure</em> contains four identical replicas of the <em><siglas>TDC</siglas></em>. 
		</p>
	</presentation_display_block>
	
	<presentation_display_block>	
		<h2>The <siglas>TDC V1 SW 28 10 19</siglas> circuit</h2>
		
		<p>In <crossref>Figure: TDC block diagram</crossref> it is shown the simplified block diagram of the <siglas>TDC V1 SW 28 10 19</siglas> circuit. The heart of the circuit is the ring of inverters, highlighted in yellow. This is a closed path with an odd number of inverters, 21 in this case, which makes it an oscillator. As seen, the first of the inverters is a NAND gate, allowing to start or stop the oscillation. There is also a second chain of identical inverters, highlighted in green, which is not closed. This line has an extra inverter in the beginning. Additionally, there is a set of 21 memories, called <code>SAFF_cell</code> in the diagram, which are differential D&nbsp;flip-flops<footnote>This flip-flop was specifically designed for this application.</footnote>, that basically store the difference of their inputs when <code>STOP</code> signal is received. Finally, there is a 7&nbsp;bit counter attached to the output of the last inverter in the non closed chain.</p>
		
		<float class="Figure" id="Figure: TDC block diagram">
			<image src="media/tdc_block diagram.svg" style="width: 1111px;"></image>
			<floatcaption>Simplified block diagram of the <siglas>TDC V1 SW 28 10 19</siglas> design. In red the two input signals <code>START</code> and <code>STOP</code> and in blue the two output buses <code>SAFF</code> and <code>COUNT</code>.</floatcaption>
		</float>
	</presentation_display_block>
	
	<presentation_display_block>	
		<h3 class="unnumbered">The working principle</h3>
		
		<p>The working principle of this circuit is simple. Initially both <code>START</code> and <code>STOP</code> signals are at a low value. In this case the ring of inverters (yellow) is in the state <code>1010...01</code> and the non closed chain (green) in state <code>0101...10</code>. The circuit is in a stationary state. When the <code>START</code> changes to a high state the NAND gate becomes a NOT gate and the state of the ring (yellow) is not stable anymore. It starts to oscillate by propagating a "wave of identical consecutive states", i.e. first it changes to <code>0010...01</code>, after the propagation time it changes to <code>0110...01</code>, and so on. The same happens with the non closed (green) chain of inverters. Each time the output of the last inverter in the non closed (green) chain commutes, the counter increments in one, registering a complete loop in the ring of inverters. In some moment in time the <code>STOP</code> signal changes to a high state and in this moment the state of the two chains of inverters is freezed by the <code>SAFF_cell</code> modules and the counter stops counting. Thus, the status of the circuit is freezed. By knowing the propagation time of the NOT gates, the conversion from the state to a time is direct and a measurement of time between the <code>START</code> and <code>STOP</code> signals is obtained.</p>
	</presentation_display_block>
	
	<presentation_display_block>	
		<p>Note that each of the <code>SAFF_cell</code> blocks in <crossref>Figure: TDC block diagram</crossref> has the <b>inputs switched</b>. As far as I know the only reason for this is to have a "more beautiful" reading in the <code>SAFF</code> bus. For example, instead of having an output of the form <code>0101101...</code> we invert each odd bit and this becomes <code>0000111...</code>. In this way it is easier to visualize in which position "the wave" is.</p>
	</presentation_display_block>
	
	<presentation_display_block>	
		<h2>The test structure</h2>
		
		<p>The test structure implemented, i.e. the piece of silicon, contains four identical replicas of the <siglas>TDC V1 SW 28 10 19</siglas> circuit. The (simplified) block diagram of the test structure is shown in <crossref>Figure: test structure block diagram</crossref>. As can be seen all the <siglas>TDC</siglas>s share the same <code>START</code> and <code>STOP</code> signals, and the only additional circuitry is a mechanism to select each of the four outputs via the <code>SEL</code> selection bus. This selection is done during the readout process, time after the time measurement has finished.</p>
		
		<float class="Figure" id="Figure: test structure block diagram">
			<image src="media/test_structure_block_diagram.svg" style="width: 555px;"></image>
			<floatcaption>Simplified block diagram of the test structure implemented. The test structure contains four identical replicas of the <siglas>TDC V1 SW 28 10 19</siglas> design which block diagram is shown in <crossref>Figure: TDC block diagram</crossref>.</floatcaption>
		</float>
	</presentation_display_block>
	
	<presentation_display_block>	
		<div style="display: flex; align-items: center; background-color: rgb(255,200,200); border-style: solid; border-color: rgb(255,111,111);">
			<p style="margin-left: 22px; margin-right: 22px">&#128545; During the characterization procedure <b>a bug was found in the silicon</b>. In the output selection mechanism (see <crossref>Figure: test structure block diagram</crossref>) the four <code>COUNT[0]</code> bits are short-circuited among them and always connected to the output, independently of the <code>SEL</code> value. Despite there is not an easy solution to this problem, a workaround was found to still be able to characterize the <siglas>TDC V1 SW 28 10 19</siglas> design.</p>
			<image src="media/bug_in_silicon.svg" style="width: 144px; max-width: 25vw;"></image>
		</div>
	</presentation_display_block>
	
	<presentation_display_block>	
		<h2>The test setup</h2>
		
		<p>Finally, in this section I will describe the outermost block which is the <em>test setup</em>. A simplified block diagram is shown in <crossref>Figure: test setup block diagram</crossref>. In the rightmost part we find the test structure, described previously. Next, going from right to left, we find the <em>delay module</em> which is a board that contains two <a href="https://www.microchip.com/wwwproducts/en/SY89296">SY89296</a> delay chips. This delay module provides the <code>START</code> and <code>STOP</code> signals with an arbitrary delay between -10&nbsp;ns and 10&nbsp;ns in steps smaller than 10&nbsp;ps and fluctuations smaller than 5&nbsp;ps (more details will be given in <crossref>Section: test setup calibration</crossref>). The rest of the signals from the test structure interface directly with an FPGA which was specifically configured for this application<footnote>For the record, the code used to program the FPGA for this work can be found in <a href="https://github.com/SengerM/PSITestSetupFPGA">this repo</a>, specifically in the commit <a href="https://github.com/SengerM/PSITestSetupFPGA/commit/fe27162759e35888a1b5c73677af94f15d5e2ab5">fe27162759e35888a1b5c73677af94f15d5e2ab5</a>.</footnote>. The FPGA is controlled by a Raspberry Py which runs software developed specifically for this work<footnote>Again, for the record, the code used in the Raspberry Pi can be found in <a href="https://github.com/SengerM/PSITestSetupRaspberriPi">this repo</a> in the commit <a href="https://github.com/SengerM/PSITestSetupRaspberriPi/commit/24143785a4c96a2dd802be2f7d97497134f91e5e">24143785a4c96a2dd802be2f7d97497134f91e5e</a>.</footnote>. The last element in the test setup, in the leftmost part, is me &#129299;.</p>
		
		
		<float class="Figure" id="Figure: test setup block diagram">
			<image src="media/test_setup_block_diagram.svg" style="width: 777px;"></image>
			<floatcaption>Simplified block diagram of the test setup. The block diagram of the <em>test structure</em> is shown in <crossref>Figure: test structure block diagram</crossref>.</floatcaption>
		</float>
	</presentation_display_block>
	
	<presentation_display_block>	
		<h1 id="Section: test setup calibration">Test setup calibration</h1>
		
		<p>Before proceeding with the characterization of the test structure a calibration procedure was performed. The setup was placed in a laboratory<footnote>Our lab at G floor.</footnote> with the ambient temperature controlled during the complete period of both calibration (of test setup) and characterization (of test structure). For this calibration, the test structure was replaced by an oscilloscope<footnote>LeCroy WaveRunner 640Zi sampling at 40&nbsp;Gs/s.</footnote> as shown in <crossref>Figure: test setup calibration block diagram</crossref>. The <code>START</code> and <code>STOP</code> signals produced by the delay module were measured with the oscilloscope and the time difference at a fixed voltage threshold was computed. This calibration procedure allowed to compensate for known deviations from the ideal behavior of the delay module&nbsp;<crossref>Reference: Characterization of delay in PSI test setup</crossref> as well as to know the systematic error introduced by the setup.</p>
		
		<float class="Figure" id="Figure: test setup calibration block diagram">
			<image src="media/test_setup_calibration_block_diagram.svg" style="width: 777px;"></image>
			<floatcaption>Simplified block diagram for the calibration of the test setup. The setup is the same as the one used for characterizing the test structure (<crossref>Figure: test setup block diagram</crossref>) but the test structure was replaced by an oscilloscope measuring the <code>START</code> and <code>STOP</code> signals.</floatcaption>
		</float>
	</presentation_display_block>
	
	<presentation_display_block>		
		<p>The results of the calibration procedure prior to the characterization of the test setup are shown in <crossref>Figure: results of calibration pre-measurement</crossref>. The measured delay follows a Gaussian distribution&nbsp;<crossref>Reference: Characterization of delay in PSI test setup</crossref>. In the two plots shown in <crossref>Figure: results of calibration pre-measurement</crossref> we find the difference between the mean of this distribution and the set delay in the left and the standard deviation of this distribution in the right, as functions of the <em>set delay</em>. The quantity we are more interested in here is the fluctuation of the delay. This quantity seems to be on the order of 4-4.5&nbsp;ps for the whole range of delays. This number contains both the systematic of the test setup and the one from the oscilloscope. It was not yet possible to measure the contribution from the oscilloscope to this number though work is being done towards this.</p>
		
		<float class="Figure" id="Figure: results of calibration pre-measurement">
			<div style="display: flex;">
				<iframe class="plotly" src="media/calibration_pre_measurement/Calibration mean error.html"></iframe>
				<iframe class="plotly" src="media/calibration_pre_measurement/Delay fluctuations vs set delay.html"></iframe>
			</div>
			<floatcaption>Results of the calibration of the test setup soon before proceeding with the characterization of the test structure. Left: <em>Calibration mean error</em> defined as the difference between the <em>set delay</em> and the <em>average of the measured delay</em>. Right: <em>Delay fluctuations</em> defined as the standard deviation of the measured delay.</floatcaption>
		</float>
	</presentation_display_block>
	
	<presentation_display_block>		
		<div style="display: flex; align-items: center; background-color: rgb(200,255,200); border-style: solid; border-color: rgb(111,222,111);">
			<p style="margin: 33px;"><b>Post characterization check.</b> The calibration-check procedure was repeated after the characterization of the <siglas>TDC</siglas> structure to ensure that the system was still performing as expected. The results obtained are almost identical to the ones in <crossref>Figure: results of calibration pre-measurement</crossref>. &#9989;</p>
		</div>
	</presentation_display_block>
	
	<presentation_display_block>	
		<h1>Characterization</h1>
		
		<p>For the characterization process the setup was assembled as in <crossref>Figure: test setup block diagram</crossref> taking care of modifying as least as possible the configuration with respect to the calibration procedure in order to not introduce unwanted effects<footnote>This setup was observed to change its calibration due to environment effects in the past&nbsp;<crossref>Reference: Characterization of delay in PSI test setup</crossref>. For this characterization the environment was kept almost untouched, for example the oscilloscope used for the calibration procedure was left untouched next to the setup even when unused during the measurements.</footnote>. In <crossref>Figure: pics of the test setup</crossref> pictures of the setup during the characterization are shown.</p>
		
		<float class="Figure" id="Figure: pics of the test setup">
			<div style="display: flex; width: 100%; flex-wrap: wrap; justify-content: space-evenly; align-items: center;">
				<image src="media/test_setup_pics/1.svg" style="width: 333px; max-width: 100%; max-height: 99vh; margin: 33px;"></image>
				<image src="media/test_setup_pics/2.svg" style="width: 333px; max-width: 100%; max-height: 99vh; margin: 33px;"></image>
			</div>
			<floatcaption>Pictures of the test setup. The oscilloscope used for the calibration procedure was left at all the time next to the setup, even when not used, to maintain the environment as close as possible to the calibration setup.</floatcaption>
		</float>
	</presentation_display_block>
	
	<presentation_display_block>
		<float class="Figure" id="Figure: distribution of outputs in time">
			<iframe class="plotly" style="min-width: 666px !important; max-width: 100% !important;" src="media/Distribution of outputs for TDC 2.html"></iframe>
			<floatcaption>Temporal distribution of each of the different outputs obtained from the <siglas>TDC V1 SW 28 10 19</siglas> circuit. To ease visualization you can enable/disable traces by clicking in the legend.</floatcaption>
		</float>
		
		<float class="Figure" id="Figure: mean time vs sequence number">
			<iframe class="plotly" src="media/Mean time vs sequence number.html"></iframe>
			<floatcaption>Mean time for each sequence as a function of the sequence number. The <em>sequence number</em> in the $x$ axis of this plot is an integer number assigned to each sequence in "crescent order", i.e. take the sequences in the legend of the plot in <crossref>Figure: distribution of outputs in time</crossref> and start numbering them; as a result you obtain the <em>sequence number</em> used in this plot. The <em>mean time</em> for each sequence (i.e. the $y$ axis in this plot) is just the mean of each distribution shown in <crossref>Figure: distribution of outputs in time</crossref>.</floatcaption>
		</float>
		
		<float class="Figure" id="Figure: time resolution vs sequence number">
			<iframe class="plotly" src="media/Time resolution vs sequence number.html"></iframe>
			<floatcaption>Time resolution as a function of the sequence number. The meaning of the <em>sequence number</em> is explained in the caption of <crossref>Figure: mean time vs sequence number</crossref>. The time resolution shown here is defined as the difference between the q<sub>95%</sub> and the q<sub>5%</sub> quantiles for the temporal distribution of each sequence, as shown in <crossref>Figure: distribution of outputs in time</crossref>.</floatcaption>
		</float>
		
		<float class="Figure" id="Figure: time resolution distribution">
			<iframe class="plotly" src="media/Time resolution histograms.html"></iframe>
			<floatcaption>Distribution of the time resolution shown in <crossref>Figure: time resolution vs sequence number</crossref>. </floatcaption>
		</float>
		
	</presentation_display_block>
	
	<presentation_display_block>
		<div id="references_list">
			<h1 class="unnumbered">References</h1>
			<reference id="Reference: Characterization of delay in PSI test setup"><em>Characterization of delay in PSI test setup</em>, M. Senger, <a href="https://msenger.web.cern.ch/characterization-of-delay-in-psi-test-setup/">https://msenger.web.cern.ch/characterization-of-delay-in-psi-test-setup/</a>.</reference>
		</div>
		
		<div id="footnotes_list">
			<h1 class="unnumbered">Footnotes</h1>
		</div>
	</presentation_display_block>
	
	
	<script src="https://sengerm.github.io/html-academic-publishing/css_and_scripts/script.js"></script> <!-- This will load the script directly from the online repo, so you don't need to download it but you need internet connection. -->
	<script src="https://sengerm.github.io/html-academic-publishing/css_and_scripts/authors.js"></script> <!-- This will load the script directly from the online repo, so you don't need to download it but you need internet connection. -->
<!--
	<script src="https://sengerm.github.io/html-academic-publishing/css_and_scripts/presentation_display_block/presentation_display_block.js"></script>
-->
</body>

</html>
